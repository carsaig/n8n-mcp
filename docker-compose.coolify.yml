services:
  n8n-mcp:
    image: 'ghcr.io/carsaig/n8n-mcp:v2.11.5'
    user: '${UID}:${GID}'
    environment:
      - MCP_MODE=http
      - 'MCP_AUTH_TOKEN=${N8N_MCP_AUTH_TOKEN}'
      - USE_FIXED_HTTP=true
      - 'AUTH_TOKEN=${N8N_MCP_AUTH_TOKEN}'
      - 'NODE_ENV=${NODE_ENV}'
      - LOG_LEVEL=debug
      - PORT=3000
      - 'BASE_URL=${BASE_URL}'
      - 'N8N_API_URL=${N8N_API_URL}'
      - 'N8N_API_KEY=${N8N_API_KEY}'
      - N8N_API_TIMEOUT=3000
      - N8N_API_MAX_RETRIES=3
      - 'CORS_ORIGIN=*'
      - TRUST_PROXY=1
      - N8N_MODE=true

    volumes:
      - '/home/ubuntu/n8n-mcp:/app/data'
      - '/home/ubuntu/n8n-mcp/logs:/app/logs'
    ports:
      - '3004:3000'
    healthcheck:
      test:
        - CMD
        - curl
        - '-f'
        - 'http://127.0.0.1:3000/health'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: always
    labels:
      - traefik.enable=true
      - traefik.http.services.n8n-mcp.loadbalancer.server.port=3000
      - 'traefik.http.routers.n8n-mcp-upstream.rule=Host(`${MCP_HOST}`) && PathPrefix(`/__upstream/mcp`)'
      - traefik.http.routers.n8n-mcp-upstream.entrypoints=https
      - traefik.http.routers.n8n-mcp-upstream.tls=true
      - traefik.http.routers.n8n-mcp-upstream.priority=20000
      - traefik.http.routers.n8n-mcp-upstream.service=n8n-mcp
      - traefik.http.routers.n8n-mcp-upstream.middlewares=n8n-mcp-strip-prefix
      - traefik.http.middlewares.n8n-mcp-strip-prefix.stripprefix.prefixes=/__upstream
      - 'traefik.http.routers.n8n-mcp-on-n8n.rule=Host(`${SERVICE_FQDN_N8N}`) && (Path(`/mcp`) || PathPrefix(`/mcp/`))'
      - traefik.http.routers.n8n-mcp-on-n8n.entrypoints=https
      - traefik.http.routers.n8n-mcp-on-n8n.tls=true
      - traefik.http.routers.n8n-mcp-on-n8n.priority=10000
      - traefik.http.routers.n8n-mcp-on-n8n.service=n8n-mcp

    networks:
      - dokk88s84sgcwg848k044o4k

networks:
  dokk88s84sgcwg848k044o4k:
    external: true
    name: dokk88s84sgcwg848k044o4k
